using System;
using Dalamud.Game.ClientState.Objects.Types;

using Dalamud.Hooking;
using Dalamud.Logging;

using FFXIVClientStructs.Havok;

namespace Ktisis.Interop.Hooks {
	public static class PoseHooks {
		private delegate ulong SetBoneModelSpaceFfxivDelegate(IntPtr partialSkeleton, ushort boneId, IntPtr transform, bool enableSecondary, bool enablePropagate);
		private static Hook<SetBoneModelSpaceFfxivDelegate> SetBoneModelSpaceFfxivHook = null!;

		private delegate IntPtr CalculateBoneModelSpaceDelegate(ref hkaPose pose, int boneIdx);
		private static Hook<CalculateBoneModelSpaceDelegate> CalculateBoneModelSpaceHook = null!;

		internal unsafe delegate void SyncModelSpaceDelegate(hkaPose* pose);
		internal static Hook<SyncModelSpaceDelegate> SyncModelSpaceHook = null!;

		private unsafe delegate byte* LookAtIKDelegate(byte* a1, long* a2, long* a3, float a4, long* a5, long* a6);
		private static Hook<LookAtIKDelegate> LookAtIKHook = null!;

		private unsafe delegate byte AnimFrozenDelegate(uint* a1, int a2);
		private static Hook<AnimFrozenDelegate> AnimFrozenHook = null!;

		internal static bool PosingEnabled { get; private set; }

		internal static unsafe void Init() {
			var setBoneModelSpaceFfxiv = Services.SigScanner.ScanText("48 8B C4 48 89 58 18 55 56 57 41 54 41 55 41 56 41 57 48 81 EC ?? ?? ?? ?? 0F 29 70 B8 0F 29 78 A8 44 0F 29 40 ?? 44 0F 29 48 ?? 48 8B 05 ?? ?? ?? ?? 48 33 C4 48 89 84 24 ?? ?? ?? ?? 48 8B B1");
			SetBoneModelSpaceFfxivHook = Hook<SetBoneModelSpaceFfxivDelegate>.FromAddress(setBoneModelSpaceFfxiv, SetBoneModelSpaceFfxivDetour);

			var calculateBoneModelSpace = Services.SigScanner.ScanText("40 53 48 83 EC 10 4C 8B 49 28");
			CalculateBoneModelSpaceHook = Hook<CalculateBoneModelSpaceDelegate>.FromAddress(calculateBoneModelSpace, CalculateBoneModelSpaceDetour);

			var syncModelSpace = Services.SigScanner.ScanText("48 83 EC 18 80 79 38 00");
			SyncModelSpaceHook = Hook<SyncModelSpaceDelegate>.FromAddress(syncModelSpace, SyncModelSpaceDetour);

			var lookAtIK = Services.SigScanner.ScanText("E8 ?? ?? ?? ?? 80 7C 24 ?? ?? 48 8D 4C 24 ??");
			LookAtIKHook = Hook<LookAtIKDelegate>.FromAddress(lookAtIK, LookAtIKDetour);

			var animFrozen = Services.SigScanner.ScanText("E8 ?? ?? ?? ?? 0F B6 F0 84 C0 74 0E");
			AnimFrozenHook = Hook<AnimFrozenDelegate>.FromAddress(animFrozen, AnimFrozenDetour);
		}

		internal static void DisablePosing() {
			CalculateBoneModelSpaceHook?.Disable();
			SetBoneModelSpaceFfxivHook?.Disable();
			SyncModelSpaceHook?.Disable();
			LookAtIKHook?.Disable();
			AnimFrozenHook?.Disable();
			PosingEnabled = false;
		}

		internal static void EnablePosing() {
			CalculateBoneModelSpaceHook?.Enable();
			SetBoneModelSpaceFfxivHook?.Enable();
			SyncModelSpaceHook?.Enable();
			LookAtIKHook?.Enable();
			AnimFrozenHook?.Enable();
			PosingEnabled = true;
		}

		/// <summary>
		/// Toggles posing mode via hooks.
		/// </summary>
		/// <returns></returns>
		internal static bool TogglePosing() {
			if (PosingEnabled) {
				CalculateBoneModelSpaceHook.Disable();
				SetBoneModelSpaceFfxivHook.Disable();
				SyncModelSpaceHook.Disable();
				LookAtIKHook.Disable();
				AnimFrozenHook.Disable();
			} else {
				CalculateBoneModelSpaceHook.Enable();
				SetBoneModelSpaceFfxivHook.Enable();
				SyncModelSpaceHook.Enable();
				LookAtIKHook.Enable();
				AnimFrozenHook.Enable();
			}
			PosingEnabled = !PosingEnabled;
			return PosingEnabled;
		}

		private static ulong SetBoneModelSpaceFfxivDetour(IntPtr partialSkeleton, ushort boneId, IntPtr transform, bool enableSecondary, bool enablePropagate) {
			return boneId;
		}

		private static unsafe IntPtr CalculateBoneModelSpaceDetour(ref hkaPose pose, int boneIdx) {
			// This is expected to return the hkQsTransform at the given index in the pose's ModelSpace transform array.
			return (IntPtr)(pose.ModelPose.Data + boneIdx);
		}

		private static unsafe void SyncModelSpaceDetour(hkaPose* pose) {
			if (!Ktisis.IsInGPose && PosingEnabled) {
				DisablePosing();
				SyncModelSpaceHook.Original(pose);
			}
		}

		public unsafe static byte* LookAtIKDetour(byte* a1, long* a2, long* a3, float a4, long* a5, long* a6) {
			return (byte*)IntPtr.Zero;
		}

		public unsafe static byte AnimFrozenDetour(uint* a1, int a2) {
			return 1;
		}

		public static unsafe void SyncBone(hkaPose* bonesPose, int index) {
			CalculateBoneModelSpaceHook.Original(ref *bonesPose, index);
		}

		public static unsafe bool IsGamePlaybackRunning(GameObject? gPoseTarget) {
			var animationControl = GetAnimationControl(gPoseTarget);
			if (animationControl == null) return true;
			return animationControl->PlaybackSpeed == 1;
		}

		public static unsafe hkaDefaultAnimationControl* GetAnimationControl(GameObject? go) {
			if (go == null) return null;
			var csObject = (FFXIVClientStructs.FFXIV.Client.Game.Object.GameObject*)go.Address;
			if (csObject->DrawObject == null ||
				csObject->DrawObject->Skeleton == null ||
				csObject->DrawObject->Skeleton->PartialSkeletons == null ||
				csObject->DrawObject->Skeleton->PartialSkeletons->GetHavokAnimatedSkeleton(0) == null ||
				csObject->DrawObject->Skeleton->PartialSkeletons->GetHavokAnimatedSkeleton(0)->AnimationControls.Length == 0 ||
				csObject->DrawObject->Skeleton->PartialSkeletons->GetHavokAnimatedSkeleton(0)->AnimationControls[0].Value == null)
				return null;
			return csObject->DrawObject->Skeleton->PartialSkeletons->GetHavokAnimatedSkeleton(0)->AnimationControls[0];
		}

		internal static void Dispose() {
			SetBoneModelSpaceFfxivHook.Disable();
			SetBoneModelSpaceFfxivHook.Dispose();
			CalculateBoneModelSpaceHook.Disable();
			CalculateBoneModelSpaceHook.Dispose();
			SyncModelSpaceHook.Disable();
			SyncModelSpaceHook.Dispose();
			LookAtIKHook.Disable();
			LookAtIKHook.Dispose();
			AnimFrozenHook.Disable();
			AnimFrozenHook.Dispose();
		}
	}
}
